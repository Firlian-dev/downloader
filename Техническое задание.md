# Техническое задание: Telegram-бот для скачивания медиа по ссылкам

## Цель
Создать бота в Telegram на Java/Spring, который принимает ссылки из Instagram, VK, YouTube, скачивает соответствующее медиа и отправляет пользователю файл или, если размер слишком большой, отправляет URL для скачивания.

## Стек технологий
- Java 21
- Spring Boot 3
- Gradle
- TelegramBots Starter
- Reactor WebClient
- MapStruct (опционально)
- Docker (для yt-dlp как внешней утилиты)

## Поддерживаемые источники
- YouTube (видео, шорты)
- VK (посты, фото, документы, видео)
- Instagram (посты, Reels, карусели)

## Общий процесс работы
1. Пользователь отправляет ссылку боту.
2. Приложение определяет провайдера по доменному имени.
3. Провайдер формирует задачу скачивания через yt-dlp или прямые URL.
4. После скачивания включается проверка размера файла:
   - Если размер допустим — бот отправляет файл пользователю.
   - Если размер слишком большой — бот отправляет URL на скачивание файла.
5. Пути файлов логируются.


## Гексагональная архитектура

Проект построен по принципам **гексагональной архитектуры** (Hexagonal Architecture, также известной как Ports & Adapters). Это архитектурный паттерн, который изолирует бизнес-логику от внешних зависимостей (БД, HTTP, UI и т.д.).

### Структура слоёв

```
src/main/java/top/firlian/downloader/
├── domain/          # Ядро приложения (Domain Layer)
│   ├── model/       # Доменные модели
│   ├── port/        # Порты (интерфейсы)
│   └── error/       # Доменные исключения
├── application/     # Слой бизнес-логики (Application Layer)
├── adapter/         # Адаптеры (Adapter Layer)
│   ├── dto/         # Data Transfer Objects
│   └── out/         # Выходные адаптеры (HTTP, Mock)
└── util/            # Утилиты (могут использоваться всеми слоями)
```

## Кэширование
- Скачанные файлы могут сохраняться во временное хранилище.
- При повторных запросах по той же ссылке файл отправляется из кэша.

## Очередь задач
- Каждая ссылка создаёт задачу скачивания.
- Очередь исключает дублирование задач для одинаковых URL.

## Поведение для нескольких медиа (карусели, плейлисты)
- По умолчанию отправляется первое медиа.
- Если несколько медиа — пользователю отправляется инлайн-клавиатура для выбора элемента.

## Логирование
- Логируются пути файлов и URL.
- Ошибки фиксируются с указанием ссылки и причины.

## Ошибки
- Приватный или недоступный контент: выдаётся сообщение «Контент недоступен».
- Ошибка скачивания: «Ошибка загрузки. Попробуйте позже».
- При невозможности определить провайдера: «Источник не поддерживается».

## Конфигурация
```
TELEGRAM_BOT_TOKEN       // токен бота
YTDLP_BIN                // путь к yt-dlp или docker socket
DOWNLOAD_DIR             // путь для временных файлов
CACHE_TTL_HOURS          // время хранения файлов
SIZE_LIMIT_MB            // лимит размера файлов для прямой отправки
```

## Тестирование
- Юнит-тесты для определения провайдера по URL.
- Тесты выбора формата и поведения при больших файлах.
- Интеграционные тесты с моканым yt-dlp.

