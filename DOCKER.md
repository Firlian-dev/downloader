# Docker Setup / Настройка Docker

## Описание

Проект использует Docker Compose для развертывания приложения с двумя основными компонентами:

1. **downloader** - Основное Spring Boot приложение с Telegram ботом
2. **ytdlp** - Отдельный сервис с утилитой yt-dlp для загрузки медиа

## Файловое хранилище

### Внешнее хранилище

По умолчанию загруженные файлы сохраняются в директорию `./downloads` на хост-машине, которая монтируется в контейнер. Это позволяет:

- Сохранить файлы при перезапуске контейнера
- Легко получить доступ к загруженным файлам с хост-машины
- Делиться файлами между несколькими контейнерами

### Структура директорий

```
downloader/
├── downloads/          # Директория для загруженных файлов (создается автоматически)
├── Dockerfile          # Dockerfile для основного приложения
├── Dockerfile.ytdlp    # Dockerfile для yt-dlp сервиса
└── docker-compose.yml  # Конфигурация Docker Compose
```

## Использование

### Запуск сервисов

```bash
# Создать .env файл с токеном бота
cp .env.example .env
# Отредактировать .env и добавить TELEGRAM_BOT_TOKEN

# Запустить все сервисы
docker-compose up -d

# Просмотр логов
docker-compose logs -f downloader

# Остановка сервисов
docker-compose down
```

### Проверка загруженных файлов

Загруженные файлы будут доступны в директории `./downloads` на хост-машине:

```bash
ls -la downloads/
```

## Конфигурация

### Переменные окружения

Основные переменные в `docker-compose.yml`:

- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота (обязательно)
- `TELEGRAM_BOT_USERNAME` - Имя пользователя бота (по умолчанию: downloader_bot)
- `DOWNLOAD_DIR` - Директория для загрузок внутри контейнера
- `CACHE_TTL_HOURS` - Время жизни кэша в часах (по умолчанию: 24)
- `SIZE_LIMIT_MB` - Максимальный размер файла для прямой отправки в MB (по умолчанию: 50)

### Использование именованного тома

Если вы хотите использовать Docker том вместо директории на хосте, раскомментируйте соответствующие строки в `docker-compose.yml`:

```yaml
volumes:
  - downloads:/app/downloads  # Именованный том Docker
  # - ./downloads:/app/downloads  # Закомментировать эту строку
```

## Архитектура

### Сервис downloader

- Основное Spring Boot приложение
- Обрабатывает запросы от Telegram бота
- Координирует загрузку медиа файлов
- Хранит загруженные файлы в `/app/downloads`

### Сервис ytdlp

- Отдельный легковесный контейнер с yt-dlp
- Предоставляет утилиту для загрузки медиа с различных платформ
- Использует общую директорию `/downloads` для хранения файлов
- Может быть использован независимо от основного приложения

## Отладка

### Проверка работы контейнеров

```bash
# Статус контейнеров
docker-compose ps

# Логи конкретного сервиса
docker-compose logs downloader
docker-compose logs ytdlp

# Войти в контейнер
docker-compose exec downloader sh
```

### Проверка монтирования томов

```bash
# Проверить монтированные тома
docker-compose exec downloader ls -la /app/downloads

# Проверить доступ к файлам на хосте
ls -la ./downloads/
```

## Обновление

### Пересборка образов

После изменения Dockerfile или кода приложения:

```bash
# Пересобрать и перезапустить
docker-compose up -d --build

# Или пересобрать конкретный сервис
docker-compose build downloader
docker-compose up -d downloader
```

### Очистка

```bash
# Остановить и удалить контейнеры
docker-compose down

# Удалить контейнеры и тома
docker-compose down -v

# Удалить образы
docker-compose down --rmi all
```
